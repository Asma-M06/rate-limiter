<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: radial-gradient(circle at top right, #1e293b, #0f172a); min-height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .status-pulse { position: relative; }
        .status-pulse::after { content: ''; position: absolute; width: 100%; height: 100%; background: inherit; border-radius: 50%; animation: pulse 2s infinite; opacity: 0.5; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2.5); opacity: 0; } }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <nav class="flex justify-between items-center mb-12">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/20">
                    <i class="fas fa-microchip text-white text-xl"></i>
                </div>
                <h1 class="text-2xl font-black tracking-tighter text-white">API rate limiter</h1>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="hidden md:flex flex-col items-end">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Redis Engine</span>
                    <span class="text-sm font-mono text-green-400">CONNECTED</span>
                </div>
                <button onclick="toggleKillSwitch()" id="kill-btn" class="bg-red-500/10 border border-red-500/50 hover:bg-red-500 text-red-500 hover:text-white px-5 py-2 rounded-full text-xs font-bold transition-all flex items-center gap-2">
                    <i class="fas fa-power-off"></i> EMERGENCY KILL
                </button>
            </div>
        </nav>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 space-y-6">
                <div class="glass rounded-3xl p-8 shadow-2xl">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-lg font-bold text-white">Traffic Throughput</h2>
                            <p class="text-slate-400 text-sm">Real-time sliding window distribution</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-black text-white" id="total-reqs">0</span>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Active Credits</p>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="usageChart"></canvas></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="glass rounded-2xl p-6">
                        <i class="fas fa-bolt text-yellow-400 mb-4"></i>
                        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest">Logic Tier</h3>
                        <p class="text-xl font-bold text-white">Throttled @ 80%</p>
                    </div>
                    <div class="glass rounded-2xl p-6">
                        <i class="fas fa-database text-blue-400 mb-4"></i>
                        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest">Persistence</h3>
                        <p class="text-xl font-bold text-white">Redis Sorted Sets</p>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-4">
                <div class="glass rounded-3xl p-6 h-full border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-white mb-6 flex items-center justify-between">
                        Live Monitor
                        <span class="bg-green-500 h-2 w-2 rounded-full status-pulse"></span>
                    </h2>
                    <div id="usage-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('usageChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Requests',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                    x: { grid: { display: false }, ticks: { color: '#64748b' } }
                }
            }
        });

        async function updateStats() {
            try {
                const res = await fetch('/admin/usage');
                const data = await res.json();
                const list = document.getElementById('usage-list');
                
                let total = 0;
                list.innerHTML = data.usageDetails.map(u => {
                    total += u.currentRequests;
                    const isEnt = u.apiKey.startsWith('ent_');
                    const isBlocked = u.blockedRequests > 0;
                    
                    return `
                        <div class="bg-slate-800/40 border border-slate-700/50 p-4 rounded-2xl transition-all hover:scale-[1.02]">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-[10px] font-mono text-slate-500 truncate max-w-[120px]">${u.apiKey}</span>
                                <span class="text-[9px] px-2 py-0.5 rounded font-black uppercase ${isBlocked ? 'bg-red-500/20 text-red-400' : (isEnt ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400')}">
                                    ${isBlocked ? 'Violated' : (isEnt ? 'Enterprise' : 'Standard')}
                                </span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <div class="flex justify-between text-[10px] mb-1 font-bold text-slate-500 uppercase">
                                        <span>Capacity</span>
                                        <span>${u.currentRequests}</span>
                                    </div>
                                    <div class="w-full bg-slate-900 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full ${isBlocked ? 'bg-red-500' : 'bg-blue-500'}" style="width: ${Math.min((u.currentRequests/10)*100, 100)}%"></div>
                                    </div>
                                </div>
                                ${isBlocked ? '<i class="fas fa-circle-exclamation text-red-500 animate-bounce"></i>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('total-reqs').innerText = total;
                myChart.data.labels = data.usageDetails.map(u => u.apiKey);
                myChart.data.datasets[0].data = data.usageDetails.map(u => u.currentRequests);
                myChart.update();
            } catch (e) { console.error(e); }
        }

        async function toggleKillSwitch() {
            const btn = document.getElementById('kill-btn');
            const isStopping = btn.innerText.includes("KILL");
            await fetch('/admin/killswitch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: isStopping })
            });
            btn.innerHTML = isStopping ? '<i class="fas fa-play"></i> RESUME SYSTEM' : '<i class="fas fa-power-off"></i> EMERGENCY KILL';
            btn.className = isStopping ? "bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-full text-xs font-bold transition-all" : "bg-red-500/10 border border-red-500/50 hover:bg-red-500 text-red-500 hover:text-white px-5 py-2 rounded-full text-xs font-bold transition-all";
        }

        setInterval(updateStats, 1000);
        updateStats();
    </script>
</body>
</html>